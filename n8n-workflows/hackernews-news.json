{
  "name": "Hacker News to SQLite",
  "nodes": [
    {
      "parameters": {
        "jsCode": "const config = {\n  sqliteDbPath: '/data/news_aggregator.db',\n  \n  llmUrl: 'http://host.docker.internal:8080/v1/chat/completions',\n  llmModel: 'gpt-oss-20b'  // Change to any model in your config.yaml\n};\n\nreturn [{ json: config }];"
      },
      "id": "081d344a-edec-4cdb-8be2-cba7f4c8ee22",
      "name": "Config",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        -368
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 6
            }
          ]
        }
      },
      "id": "26e99844-b992-407e-baff-14c1dcb8de5a",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        304,
        -368
      ]
    },
    {
      "parameters": {
        "resource": "all",
        "limit": 25,
        "additionalFields": {
          "tags": [
            "front_page"
          ]
        }
      },
      "type": "n8n-nodes-base.hackerNews",
      "typeVersion": 1,
      "position": [
        704,
        -368
      ],
      "id": "7624c7d0-b422-45e8-9683-23ba4eb2bb00",
      "name": "Get Top 25 Posts"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "6bf20728-9390-4f5a-8da8-64a1145ecd21",
      "name": "Loop Over Items",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        912,
        -368
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extract article info and prepare for content fetching\nconst config = $('⚙️ Configuration').first().json;\nconst data = $input.item.json;\n\n// Get the URL - HN items have 'url' for external links or use HN discussion URL\nconst articleUrl = data.url || `https://news.ycombinator.com/item?id=${data.objectID || data.id}`;\nconst hnUrl = `https://news.ycombinator.com/item?id=${data.objectID || data.id}`;\n\nreturn {\n  json: {\n    title: data.title,\n    url: articleUrl,\n    hnUrl: hnUrl,\n    points: data.points || 0,\n    numComments: data.num_comments || 0,\n    author: data.author || 'unknown',\n    objectID: String(data.objectID || data.id),\n    createdAt: data.created_at || null,\n    config: config\n  }\n};"
      },
      "id": "5505e261-6349-49ca-a874-4eb7129f0d68",
      "name": "Extract Article Info",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1104,
        -368
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            },
            {
              "name": "Accept",
              "value": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "text"
            }
          },
          "timeout": 15000
        }
      },
      "id": "2a8021e4-5a59-48a8-8f04-5797d0c5dfbe",
      "name": "Fetch Article Content",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1312,
        -368
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Extract text content from HTML and merge with article info\nconst input = $input.item.json;\n\n// Get article info passed from previous node\nconst articleInfo = $('Extract Article Info').first().json;\n\n// The HTTP response could be in different fields depending on response type and n8n version\n// When responseFormat is 'text', n8n puts the response in 'data' field\n// When there's an error, it might be in 'error' or just pass through the error object\nlet html = '';\nif (typeof input === 'string') {\n  html = input;\n} else if (input.data) {\n  html = String(input.data);\n} else if (input.body) {\n  html = String(input.body);\n} else if (input.response) {\n  html = String(input.response);\n}\n\n// Check if we got an error response\nconst hasError = input.error || input.errorMessage || (input.statusCode && input.statusCode >= 400);\n\n// Simple HTML to text conversion\nlet text = html\n  .replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, '')\n  .replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, '')\n  .replace(/<nav[^>]*>[\\s\\S]*?<\\/nav>/gi, '')\n  .replace(/<header[^>]*>[\\s\\S]*?<\\/header>/gi, '')\n  .replace(/<footer[^>]*>[\\s\\S]*?<\\/footer>/gi, '')\n  .replace(/<[^>]+>/g, ' ')\n  .replace(/&nbsp;/g, ' ')\n  .replace(/&amp;/g, '&')\n  .replace(/&lt;/g, '<')\n  .replace(/&gt;/g, '>')\n  .replace(/&quot;/g, '\"')\n  .replace(/&#39;/g, \"'\")\n  .replace(/\\s+/g, ' ')\n  .trim();\n\n// Limit text length for summarization\ntext = text.substring(0, 4000);\n\n// Determine if we have meaningful content (at least 100 chars of actual text)\nconst hasContent = !hasError && text.length > 100;\n\nreturn {\n  json: {\n    title: articleInfo.title,\n    url: articleInfo.url,\n    hnUrl: articleInfo.hnUrl,\n    points: articleInfo.points,\n    numComments: articleInfo.numComments,\n    author: articleInfo.author,\n    objectID: articleInfo.objectID,\n    createdAt: articleInfo.createdAt,\n    content: hasContent ? text : 'This is a link or discussion post without article content. Please summarize based on the title only.',\n    hasContent: hasContent,\n    config: articleInfo.config\n  }\n};"
      },
      "id": "37e59ce1-ea35-432a-b772-58f51c645da0",
      "name": "Parse HTML Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1504,
        -368
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.config.llmUrl }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: $json.config.llmModel, messages: [{ role: 'system', content: 'You are a helpful assistant that summarizes articles concisely. Create a 2-3 sentence summary that captures the key points. Be direct and informative. Do not use markdown formatting.' }, { role: 'user', content: 'Summarize this article titled \"' + $json.title + '\":\\n\\n' + $json.content }], temperature: 0.3, max_tokens: 300 }) }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 120000
        }
      },
      "id": "d61196fa-8337-4d87-91e0-52e68c0f93e3",
      "name": "Summarize with Local LLM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1712,
        -368
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Prepare data for Datasette Insert API\nconst articleInfo = $('Parse HTML Content').first().json;\nconst llmResponse = $input.item.json;\n\n// Extract summary from OpenAI-compatible response format\nlet summary = 'Summary generation failed';\n\ntry {\n  if (llmResponse && llmResponse.choices && llmResponse.choices[0] && llmResponse.choices[0].message && llmResponse.choices[0].message.content) {\n    summary = llmResponse.choices[0].message.content.trim();\n  } else if (llmResponse && llmResponse.content) {\n    summary = llmResponse.content.trim();\n  } else if (llmResponse && llmResponse.text) {\n    summary = llmResponse.text.trim();\n  } else if (llmResponse && llmResponse.error) {\n    summary = 'LLM Error: ' + JSON.stringify(llmResponse.error);\n  } else if (llmResponse && llmResponse.message) {\n    // Sometimes errors come as { message: 'error text' }\n    summary = 'Error: ' + llmResponse.message;\n  } else {\n    summary = 'No valid response from LLM. Response: ' + JSON.stringify(llmResponse).substring(0, 200);\n  }\n} catch (e) {\n  summary = 'Error parsing LLM response: ' + e.message;\n}\n\n// Calculate engagement score\nconst engagementScore = articleInfo.points + articleInfo.numComments;\n\n// Prepare metadata JSON for HackerNews-specific fields\nconst metadata = JSON.stringify({\n  hn_url: articleInfo.hnUrl,\n  type: 'story'\n});\n\n// Return data matching the news_items table schema\nreturn {\n  json: {\n    platform: 'hackernews',\n    external_id: String(articleInfo.objectID),\n    title: articleInfo.title,\n    summary: summary,\n    url: articleInfo.url,\n    author: articleInfo.author || 'unknown',\n    upvotes: articleInfo.points || 0,\n    downvotes: 0,\n    comments_count: articleInfo.numComments || 0,\n    engagement_score: engagementScore,\n    category: 'front_page',\n    thumbnail_url: null,\n    published_at: articleInfo.createdAt || null,\n    metadata: metadata\n  }\n};"
      },
      "id": "c59df529-9c8e-4d22-9273-e0928c4ac055",
      "name": "Prepare for SQLite",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1904,
        -368
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://lllm-datasette:8001/-/insert/news_aggregator/news_items?replace=1",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $env.DATASETTE_INSERT_TOKEN }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 10000
        }
      },
      "id": "46f29cd9-c085-46c4-b67b-b8ad34e3dab5",
      "name": "Save to SQLite",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2112,
        -368
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "⚙️ Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "⚙️ Configuration": {
      "main": [
        [
          {
            "node": "Get Top 10 Posts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Top 10 Posts": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Extract Article Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Article Info": {
      "main": [
        [
          {
            "node": "Fetch Article Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Article Content": {
      "main": [
        [
          {
            "node": "Parse HTML Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse HTML Content": {
      "main": [
        [
          {
            "node": "Summarize with Local LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summarize with Local LLM": {
      "main": [
        [
          {
            "node": "Prepare for SQLite",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for SQLite": {
      "main": [
        [
          {
            "node": "Save to SQLite",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to SQLite": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "b9c8c266-5301-497f-822d-2b548ddda204",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "174d1d97b115aa1370077cd95974f6ef935834bbc57dae8c93e03ef97933c6d6"
  },
  "id": "wGzOYc3ZuC5eFRYj",
  "tags": [
    {
      "updatedAt": "2025-12-04T15:21:22.695Z",
      "createdAt": "2025-12-04T15:21:22.695Z",
      "id": "9pB6ghsbTzKQzXRp",
      "name": "discord"
    },
    {
      "updatedAt": "2025-12-05T07:26:25.724Z",
      "createdAt": "2025-12-05T07:26:25.724Z",
      "id": "GpYmB9yPBawNM4hJ",
      "name": "github"
    },
    {
      "updatedAt": "2025-12-04T15:21:22.694Z",
      "createdAt": "2025-12-04T15:21:22.694Z",
      "id": "X6cxmsCFwMLW6CZJ",
      "name": "automation"
    },
    {
      "updatedAt": "2025-12-04T15:21:22.692Z",
      "createdAt": "2025-12-04T15:21:22.692Z",
      "id": "ntZT90gtTiNA9tYs",
      "name": "news"
    },
    {
      "updatedAt": "2025-12-06T10:33:31.314Z",
      "createdAt": "2025-12-06T10:33:31.314Z",
      "id": "ooJOi8AmuXEdeJal",
      "name": "sqlite"
    },
    {
      "updatedAt": "2025-12-06T10:33:31.321Z",
      "createdAt": "2025-12-06T10:33:31.321Z",
      "id": "dKOdBYvynAtd4edu",
      "name": "hackernews"
    },
    {
      "updatedAt": "2025-12-06T10:33:31.327Z",
      "createdAt": "2025-12-06T10:33:31.327Z",
      "id": "JorrG9lmzOLmXA8d",
      "name": "ai-summary"
    }
  ]
}