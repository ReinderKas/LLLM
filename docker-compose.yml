services:
  # Open WebUI - Full-featured chat interface with RAG, Memory, Web Search
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: lllm-webui
    ports:
      - "3000:8080"
    environment:
      - OPENAI_API_BASE_URL=http://host.docker.internal:8080/v1
      - OPENAI_API_KEY=not-needed
      - ENABLE_RAG_WEB_SEARCH=true
      - RAG_EMBEDDING_MODEL=all-MiniLM-L6-v2
      - ENABLE_RAG_LOCAL_WEB_FETCH=true
    volumes:
      - open-webui-data:/app/backend/data
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # n8n - Workflow automation
  n8n:
    image: n8nio/n8n:latest
    container_name: lllm-n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=Europe/Amsterdam
      - TZ=Europe/Amsterdam
      - DATASETTE_INSERT_TOKEN=${DATASETTE_INSERT_TOKEN}
    volumes:
      - n8n-data:/home/node/.n8n
      - ./data:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # Datasette - REST API for SQLite database
  datasette:
    build:
      context: .
      dockerfile_inline: |
        FROM python:3.12-slim
        RUN pip install --no-cache-dir datasette datasette-insert datasette-auth-tokens
        EXPOSE 8001
    container_name: lllm-datasette
    ports:
      - "8001:8001"
    environment:
      - DATASETTE_INSERT_TOKEN=${DATASETTE_INSERT_TOKEN}
    volumes:
      - ./data:/data
      - ./datasette-metadata.json:/metadata.json:ro
    command: datasette /data/news_aggregator.db --host 0.0.0.0 --port 8001 --cors --setting sql_time_limit_ms 5000 --metadata /metadata.json
    restart: unless-stopped

volumes:
  open-webui-data:
  n8n-data:
